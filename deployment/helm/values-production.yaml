# Production values for referral-pulse-svc
# Usage: helm upgrade --install referral-svc ./deployment/helm -f ./deployment/helm/values-production.yaml

replicaCount: 5

image:
  repository: your-ecr-registry/referral-pulse-svc
  tag: "v1.0.0"
  pullPolicy: IfNotPresent

serviceAccount:
  irsa:
    enabled: true
    roleArn: arn:aws:iam::123456789012:role/referral-pulse-svc-prod-role

resources:
  limits:
    cpu: 1000m
    memory: 1024Mi
  requests:
    cpu: 500m
    memory: 512Mi

autoscaling:
  enabled: true
  minReplicas: 5
  maxReplicas: 50
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

pdb:
  enabled: true
  minAvailable: 2

# Production environment variables
envVars:
  NODE_ENV: "production"
  APP_PORT: "8080"
  FRONTEND_DOMAIN: "https://app.example.com"
  BACKEND_DOMAIN: "https://api.example.com"
  API_PREFIX: "api"
  APP_FALLBACK_LANGUAGE: "en"
  APP_HEADER_LANGUAGE: "x-custom-lang"

  # Database - Production RDS
  DATABASE_TYPE: "postgres"
  DATABASE_HOST: "referral-db-prod.xxxx.eu-central-1.rds.amazonaws.com"
  DATABASE_PORT: "5432"
  DATABASE_NAME: "referral_db_prod"
  DATABASE_USERNAME: "app_user"
  DATABASE_SYNCHRONIZE: "false"
  DATABASE_MAX_CONNECTIONS: "200"
  DATABASE_SSL_ENABLED: "true"
  DATABASE_LOGGING: "false"

  # Redis - Production ElastiCache Cluster
  REDIS_HOST: "referral-prod.xxxx.cache.amazonaws.com"
  REDIS_PORT: "6379"
  REDIS_DB: "0"
  REDIS_TLS_ENABLED: "true"
  REDIS_KEY_PREFIX: "rp:prod:"

  # AWS
  AWS_REGION: "eu-central-1"
  AWS_ENDPOINT: ""

  # S3 - Production Bucket
  AWS_S3_BUCKET: "referral-pulse-production"
  AWS_S3_REGION: "eu-central-1"
  AWS_S3_ENDPOINT: ""

  # SQS Queues - Production
  SQS_QUEUE_CAMPAIGN_EVENTS: "https://sqs.eu-central-1.amazonaws.com/123456789012/prod-campaign-events.fifo"
  SQS_QUEUE_REFERRAL_EVENTS: "https://sqs.eu-central-1.amazonaws.com/123456789012/prod-referral-events.fifo"
  SQS_QUEUE_REWARD_EVENTS: "https://sqs.eu-central-1.amazonaws.com/123456789012/prod-reward-events.fifo"
  SQS_QUEUE_USER_EVENTS: "https://sqs.eu-central-1.amazonaws.com/123456789012/prod-user-events.fifo"
  SQS_QUEUE_NOTIFICATION_EVENTS: "https://sqs.eu-central-1.amazonaws.com/123456789012/prod-notification-events.fifo"
  SQS_QUEUE_ANALYTICS_EVENTS: "https://sqs.eu-central-1.amazonaws.com/123456789012/prod-analytics-events.fifo"
  SQS_QUEUE_WORKFLOW_EVENTS: "https://sqs.eu-central-1.amazonaws.com/123456789012/prod-workflow-events.fifo"

  # SQS Configuration
  SQS_POLLING_ENABLED: "true"
  SQS_POLLING_WAIT_TIME_SECONDS: "20"
  SQS_POLLING_VISIBILITY_TIMEOUT: "60"
  SQS_POLLING_MAX_MESSAGES: "10"
  SQS_POLLING_TERMINATE_VISIBILITY_TIMEOUT: "0"

  # SNS - Production
  SNS_TOPIC_ARN: "arn:aws:sns:eu-central-1:123456789012:prod-campaign-notifications"

  # JWT/Auth - Production Auth Provider
  AUTH_JWKS_URI: "https://auth.example.com/.well-known/jwks.json"
  AUTH_ISSUER: "https://auth.example.com/"
  AUTH_AUDIENCE: "referral-pulse-api"
  AUTH_ALGORITHMS: "RS256"
  AUTH_TENANT_CLAIM_PATH: "tenantId"
  AUTH_CLOCK_TOLERANCE: "30"
  AUTH_CACHE_ENABLED: "true"
  AUTH_CACHE_TTL: "600"

  # HTTP Client - Internal
  INTRA_HTTP_BASE_URL: "http://gateway.internal:3000"
  INTRA_HTTP_TIMEOUT_MS: "3000"
  INTRA_TENANT_HEADER: "x-tenant-id"
  INTRA_JWT_HEADER_NAME: "authorization"
  INTRA_HTTP_RETRIES: "3"
  INTRA_HTTP_RETRY_BASE_DELAY_MS: "200"
  INTRA_HTTP_RETRY_STATUSES: "429,502,503,504"

  # HTTP Client - Third Party
  TP_HTTP_BASE_URL: "https://api.thirdparty.com"
  TP_HTTP_TIMEOUT_MS: "5000"
  TP_HTTP_UA: "referral-pulse-svc/1.0"
  TP_HTTP_RETRIES: "3"
  TP_HTTP_RETRY_BASE_DELAY_MS: "500"
  TP_HTTP_RETRY_STATUSES: "429,500,502,503,504"

  # Circuit Breaker - Internal
  INTRA_CB_TIMEOUT_MS: "2500"
  INTRA_CB_VOLUME_THRESHOLD: "50"
  INTRA_CB_ERR_PCT: "50"
  INTRA_CB_RESET_TIMEOUT_MS: "10000"

  # Circuit Breaker - Third Party
  TP_CB_TIMEOUT_MS: "4000"
  TP_CB_VOLUME_THRESHOLD: "30"
  TP_CB_ERR_PCT: "50"
  TP_CB_RESET_TIMEOUT_MS: "15000"

  # Metrics
  METRICS_ENABLED: "true"
  METRICS_ENDPOINT: "/metrics"

  # OpenTelemetry - Grafana Cloud Production
  OTEL_ENABLED: "true"
  OTEL_SERVICE_NAME: "referral-pulse-svc"
  OTEL_SERVICE_VERSION: "1.0.0"
  OTEL_EXPORTER_OTLP_ENDPOINT: "https://otlp-gateway-prod-eu-central-0.grafana.net/otlp"
  OTEL_EXPORTER_OTLP_PROTOCOL: "http/protobuf"
  OTEL_EXPORTER_OTLP_HEADERS: "Authorization=Basic <base64-encoded-token>"

  # Logging - Production (structured, no pretty print)
  LOGGING_LEVEL: "warn"
  LOGGING_PRETTY: "false"

  # ClickHouse - Production Analytics
  CH_URL: "https://clickhouse-prod.example.com:8443"
  CH_USERNAME: "app_user"
  CH_DATABASE: "analytics_prod"

secretVars:
  # Database
  DATABASE_PASSWORD: "production-db-password-from-secrets-manager"

  # Redis (if auth enabled)
  REDIS_USERNAME: ""
  REDIS_PASSWORD: "production-redis-password-from-secrets-manager"

  # ClickHouse
  CH_PASSWORD: "production-clickhouse-password-from-secrets-manager"

  # Third Party API Keys
  TP_API_KEY: "production-api-key-from-secrets-manager"

# Production ingress
ingress:
  enabled: true
  className: "alb"
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/healthcheck-path: /health
    alb.ingress.kubernetes.io/healthcheck-port: traffic-port
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS":443}]'
    alb.ingress.kubernetes.io/backend-protocol: HTTP
    alb.ingress.kubernetes.io/success-codes: "200-399"
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:eu-central-1:123456789012:certificate/xxxxxx
    alb.ingress.kubernetes.io/ssl-policy: ELBSecurityPolicy-TLS-1-2-2017-01
    alb.ingress.kubernetes.io/group.name: referral-prod
    external-dns.alpha.kubernetes.io/hostname: api.example.com
  hosts:
    - host: api.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: tls-acm-placeholder
      hosts:
        - api.example.com

# Production topology spread for high availability
topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: DoNotSchedule
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: referral-svc
  - maxSkew: 1
    topologyKey: kubernetes.io/hostname
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: referral-svc
